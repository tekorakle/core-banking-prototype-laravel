# ============================================================================
# FinAegis - Nginx Server Configuration
# ============================================================================

upstream php-fpm {
    server 127.0.0.1:9000;
    keepalive 32;
}

server {
    listen 80;
    server_name _;
    root /var/www/html/public;
    index index.php;

    # Charset
    charset utf-8;

    # Logging
    access_log /var/log/nginx/access.log json;
    error_log /var/log/nginx/error.log;

    # Request ID for tracing
    set $request_id $request_id;
    if ($http_x_request_id) {
        set $request_id $http_x_request_id;
    }

    # Security headers
    add_header X-Request-ID $request_id always;

    # -------------------------------------------------------------------------
    # Health and monitoring endpoints (no rate limiting)
    # -------------------------------------------------------------------------

    location /api/monitoring/alive {
        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    location /api/monitoring/ready {
        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    location /api/monitoring/health {
        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    location /api/monitoring/metrics {
        # Prometheus metrics - restrict to internal access
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        allow 127.0.0.1;
        deny all;

        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    # PHP-FPM status (internal only)
    location /fpm-status {
        allow 127.0.0.1;
        deny all;
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location /fpm-ping {
        allow 127.0.0.1;
        deny all;
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }

    # -------------------------------------------------------------------------
    # Authentication endpoints (strict rate limiting)
    # -------------------------------------------------------------------------

    location ~ ^/api/auth/(login|register) {
        limit_req zone=auth burst=5 nodelay;
        limit_conn conn_limit 10;

        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    # -------------------------------------------------------------------------
    # API endpoints (standard rate limiting)
    # -------------------------------------------------------------------------

    location /api {
        limit_req zone=api burst=50 nodelay;
        limit_conn conn_limit 100;

        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    # -------------------------------------------------------------------------
    # Broadcasting/WebSocket authentication
    # -------------------------------------------------------------------------

    location /broadcasting/auth {
        try_files $uri /index.php?$query_string;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    # -------------------------------------------------------------------------
    # Static assets (long cache)
    # -------------------------------------------------------------------------

    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
        try_files $uri =404;
    }

    # Vite build assets (hashed filenames = immutable)
    location /build {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
        try_files $uri =404;
    }

    # -------------------------------------------------------------------------
    # Swagger docs (prevent conflict with public/docs/ directory)
    # -------------------------------------------------------------------------

    location = /docs {
        try_files /index.php?$query_string =404;
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;
    }

    # -------------------------------------------------------------------------
    # Main application
    # -------------------------------------------------------------------------

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    # -------------------------------------------------------------------------
    # PHP processing
    # -------------------------------------------------------------------------

    location ~ \.php$ {
        fastcgi_pass php-fpm;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param HTTP_X_REQUEST_ID $request_id;

        # Hide PHP version
        fastcgi_hide_header X-Powered-By;
    }

    # -------------------------------------------------------------------------
    # Security
    # -------------------------------------------------------------------------

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to sensitive files
    location ~ /(?:composer\.json|composer\.lock|\.env|package\.json|package-lock\.json) {
        deny all;
    }

    # Deny access to storage and bootstrap/cache
    location ~ ^/(storage|bootstrap/cache) {
        deny all;
    }
}
