name: Security Scan Pipeline

on:
  workflow_call:
    inputs:
      php-version:
        description: 'PHP version to use'
        required: false
        default: '8.4'
        type: string
    secrets:
      GITLEAKS_LICENSE:
        required: false

env:
  PHP_VERSION: ${{ inputs.php-version }}

jobs:
  secret-scanning:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  security-audit:
    name: Security Vulnerability Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none
          
      - name: Setup Environment
        run: |
          cp .env.testing .env
          
      - name: Install Dependencies
        run: composer install --prefer-dist --no-progress --no-dev
        
      - name: Run Security Audit (Production Dependencies)
        id: audit-prod
        run: |
          echo "## Production Dependencies Audit" >> $GITHUB_STEP_SUMMARY
          # Run audit and capture output
          if ! composer audit --no-dev --format=json > audit-prod.json 2>&1; then
            echo "Vulnerabilities found in production dependencies"
            cat audit-prod.json | jq '.' || cat audit-prod.json

            # Check for critical or high severity vulnerabilities
            CRITICAL_COUNT=$(cat audit-prod.json | jq '[.advisories[]? | select(.severity == "critical" or .severity == "high")] | length // 0' 2>/dev/null || echo "0")

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::error::Found $CRITICAL_COUNT critical/high severity vulnerabilities in production dependencies!"
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Critical/High | $CRITICAL_COUNT |" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            echo "::warning::Found vulnerabilities in production dependencies (no critical/high severity)"
          else
            echo "No vulnerabilities found in production dependencies"
            echo "✅ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Security Audit (All Dependencies)
        id: audit-all
        run: |
          echo "## All Dependencies Audit" >> $GITHUB_STEP_SUMMARY
          # Run audit on all dependencies including dev
          if ! composer audit --format=json > audit-all.json 2>&1; then
            echo "Vulnerabilities found in all dependencies"
            cat audit-all.json | jq '.' || cat audit-all.json

            # Check for critical or high severity vulnerabilities
            CRITICAL_COUNT=$(cat audit-all.json | jq '[.advisories[]? | select(.severity == "critical" or .severity == "high")] | length // 0' 2>/dev/null || echo "0")

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::error::Found $CRITICAL_COUNT critical/high severity vulnerabilities!"
              echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
              echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Critical/High | $CRITICAL_COUNT |" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi

            echo "::warning::Found vulnerabilities (no critical/high severity)"
          else
            echo "No vulnerabilities found"
            echo "✅ No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi