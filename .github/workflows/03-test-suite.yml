name: Test Suite Pipeline

on:
  workflow_call:
    inputs:
      php-version:
        description: 'PHP version to use'
        required: false
        default: '8.4'
        type: string
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '20'
        type: string
    secrets:
      CODECOV_TOKEN:
        required: false

env:
  PHP_VERSION: ${{ inputs.php-version }}
  NODE_VERSION: ${{ inputs.node-version }}
  COMPOSER_PROCESS_TIMEOUT: 0
  COMPOSER_NO_INTERACTION: 1
  COMPOSER_NO_AUDIT: 1

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis, opcache, pcntl, gd, imagick, bcmath, intl, zip, soap, gmp
          tools: composer:v2
          coverage: xdebug
          ini-values: |
            memory_limit=1G
            max_execution_time=360
            
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT
        
      - name: Cache Dependencies
        uses: actions/cache@v5
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
            node_modules
            ~/.npm
          key: ${{ runner.os }}-deps-${{ hashFiles('**/composer.lock', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-
            
      - name: Setup Environment
        run: |
          cp .env.testing .env
          
      - name: Install PHP Dependencies
        run: |
          # Try composer install with retry logic for flaky downloads
          for i in 1 2 3; do
            if composer install --prefer-dist --no-progress --optimize-autoloader; then
              echo "Composer install succeeded on attempt $i"
              break
            else
              echo "Composer install failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All attempts failed"
                exit 1
              fi
              echo "Retrying in 5 seconds..."
              sleep 5
              # Clear composer cache for problematic packages
              composer clear-cache
            fi
          done
          composer dump-autoload
          
      - name: Install Node Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Prepare Laravel Application
        run: |
          # Configure MySQL database connection for CI
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env
          
          # Note: Route caching disabled to prevent memory exhaustion in tests
          php artisan config:clear
          php artisan route:clear
          php artisan migrate --force
          
      - name: Run Unit Tests
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: ":memory:"
          CI: true
          PEST_NO_SORT: true
          MEMORY_LIMIT: 1G
          PEST_PARALLEL: true
          PARALLEL_PROCS: 2
        run: |
          # Run unit tests using SQLite in-memory database
          # Memory increased to 1G and parallel enabled with 2 processes

          # Use the batch runner for memory-efficient execution
          chmod +x ./bin/pest-batch

          # First batch: Domain unit tests (parallel enabled)
          ./bin/pest-batch tests/Unit/Domain || exit 1

          # Second batch: HTTP and Services unit tests (parallel enabled)
          ./bin/pest-batch tests/Unit/Http tests/Unit/Services || exit 1

          # Third batch: Other unit tests (if they exist)
          if [ -d "tests/Unit/Filament" ] || [ -d "tests/Unit/Http/Middleware" ]; then
            ./bin/pest-batch tests/Unit/Filament tests/Unit/Http/Middleware || exit 1
          fi
          
      # NOTE: Security tests are NOT run here to avoid duplication.
      # Security tests run comprehensively in 04-security-tests.yml with MySQL:
      # - Penetration Tests
      # - Authentication Security Tests
      # - API Security Tests
      # - Vulnerability Tests

      # Coverage upload disabled since we're not generating coverage to save memory
      # - name: Upload Test Coverage
      #   uses: codecov/codecov-action@v4
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     file: ./coverage.xml
      #     flags: unittests
      #     name: codecov-umbrella

  feature-tests:
    name: Feature Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis, opcache, pcntl, gd, imagick, bcmath, intl, zip, soap, gmp
          tools: composer:v2
          coverage: xdebug
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Dependencies
        uses: actions/cache@v5
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
            node_modules
            ~/.npm
          key: ${{ runner.os }}-feature-deps-${{ hashFiles('**/composer.lock', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-feature-deps-

      - name: Setup Environment
        run: |
          cp .env.testing .env

      - name: Install Dependencies
        run: |
          # Try composer install with retry logic for flaky downloads
          for i in 1 2 3; do
            if composer install --prefer-dist --no-progress --optimize-autoloader; then
              echo "Composer install succeeded on attempt $i"
              break
            else
              echo "Composer install failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All attempts failed"
                exit 1
              fi
              echo "Retrying in 5 seconds..."
              sleep 5
              # Clear composer cache for problematic packages
              composer clear-cache
            fi
          done
          npm ci --prefer-offline --no-audit
          npm run build

      - name: Prepare Laravel Application
        run: |
          # Configure MySQL database connection for CI
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env

          # Note: Route caching disabled to prevent memory exhaustion in tests
          php artisan config:clear
          php artisan route:clear
          php artisan migrate --force

      - name: Run Feature Tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
          CI: true
          PEST_NO_SORT: true
          MEMORY_LIMIT: 2G
          PEST_PARALLEL: false
        run: |
          # Run feature tests in batches with 2G memory
          # Parallel disabled for feature tests (database state conflicts)

          # Use the batch runner for memory-efficient execution
          chmod +x ./bin/pest-batch

          # First batch: Critical feature tests
          ./bin/pest-batch tests/Feature/Http tests/Feature/Api || exit 1

          # Second batch: Domain feature tests
          ./bin/pest-batch tests/Feature/Domain tests/Feature/Models || exit 1

          # Third batch: Other feature tests
          ./bin/pest-batch tests/Feature/Cache tests/Feature/Exchange tests/Feature/Basket || exit 1

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis, opcache, pcntl, gd, imagick, bcmath, intl, zip, soap, gmp
          tools: composer:v2
          coverage: xdebug

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer Dependencies
        uses: actions/cache@v5
        with:
          path: |
            ${{ steps.composer-cache.outputs.dir }}
            vendor
          key: ${{ runner.os }}-integration-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-integration-composer-

      - name: Setup Environment
        run: |
          cp .env.testing .env

      - name: Install Dependencies
        run: |
          # Try composer install with retry logic for flaky downloads
          for i in 1 2 3; do
            if composer install --prefer-dist --no-progress --optimize-autoloader; then
              echo "Composer install succeeded on attempt $i"
              break
            else
              echo "Composer install failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All attempts failed"
                exit 1
              fi
              echo "Retrying in 5 seconds..."
              sleep 5
              # Clear composer cache for problematic packages
              composer clear-cache
            fi
          done

      - name: Prepare Laravel Application
        run: |
          cp .env.testing .env
          # Configure MySQL database connection for CI
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env

          php artisan key:generate
          php artisan config:cache
          php artisan migrate --force

      - name: Run Integration Tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root
        run: php -d memory_limit=2G ./vendor/bin/pest --testsuite=Integration --configuration=phpunit.ci-optimized.xml --exclude-group=slow
        
  behat-tests:
    name: Behat Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, dom, fileinfo, mysql, redis, opcache, pcntl, gd, imagick, bcmath, intl, zip, soap, curl, gmp
          tools: composer:v2
          coverage: none
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Setup Environment
        run: |
          cp .env.testing .env
          
      - name: Install Dependencies
        run: |
          # Try composer install with retry logic for flaky downloads
          for i in 1 2 3; do
            if composer install --prefer-dist --no-progress --optimize-autoloader; then
              echo "Composer install succeeded on attempt $i"
              break
            else
              echo "Composer install failed on attempt $i"
              if [ $i -eq 3 ]; then
                echo "All attempts failed"
                exit 1
              fi
              echo "Retrying in 5 seconds..."
              sleep 5
              # Clear composer cache for problematic packages
              composer clear-cache
            fi
          done
          npm ci --prefer-offline --no-audit
          npm run build
          
      - name: Prepare Laravel Application
        run: |
          # Add MySQL connection details
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env
          
          # Clear and rebuild all caches to ensure configs are loaded
          php artisan config:clear
          php artisan cache:clear
          php artisan config:cache
          php artisan route:cache
          
          # Wait for MySQL to be fully ready
          timeout 30 bash -c 'until echo "SELECT 1" | mysql -h127.0.0.1 -P3306 -uroot -proot testing; do echo "Waiting for MySQL..."; sleep 2; done'
          
          # Run all migrations (permission tables migration already exists in project)
          php artisan migrate --force
          
          # List tables to verify migrations ran (debug info)
          echo "=== Database Tables ==="
          php artisan db:show --counts || true
          
          # Seed database with test data (includes roles)
          echo "=== Seeding Database ==="
          php artisan db:seed --class=TestSeeder --verbose
          
      - name: Start Laravel Server
        run: |
          php artisan serve --host=127.0.0.1 --port=8000 &
          sleep 5
          
      - name: Run Behat Tests
        env:
          BEHAT_BASE_URL: http://127.0.0.1:8000
          QUEUE_CONNECTION: sync
          CI: true
        run: |
          # Run only implemented feature files to avoid parsing 19 unimplemented ones
          # CI=true enables reduced wait times (500ms vs 2-3s) in Behat contexts
          mkdir -p tests-results

          # Run account_management.feature with JUnit output
          vendor/bin/behat \
            --no-interaction \
            --format=progress \
            --format=junit \
            --out=std \
            --out=tests-results \
            --stop-on-failure \
            features/account_management.feature

          # Run basket_management.feature with JUnit output
          vendor/bin/behat \
            --no-interaction \
            --format=progress \
            --format=junit \
            --out=std \
            --out=tests-results \
            --stop-on-failure \
            features/basket_management.feature

      - name: Upload Behat Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: behat-results
          path: tests-results/