# v1.3.0 Implementation Plan - Platform Modularity

> **Target**: Q2 2026
> **Theme**: Pick-and-Choose Domain Installation
> **Created**: January 13, 2026
> **Status**: ✅ **COMPLETED** - January 25, 2026

---

## Completion Summary

| Phase | Status | Completion Date |
|-------|--------|-----------------|
| Phase 1: Interface Extraction | ✅ Complete | Jan 23, 2026 |
| Phase 2: Security Implementation | ✅ Complete | Jan 23, 2026 |
| Phase 3: Module Manifest System | ✅ Complete | Jan 24, 2026 |
| Phase 4: Installation Commands | ✅ Complete | Jan 24, 2026 |

### Key Deliverables
- **4 Shared Interfaces**: WalletOperationsInterface, AssetTransferInterface, PaymentProcessingInterface, AccountQueryInterface
- **Security Traits**: FinancialInputValidator, AuditLogger
- **29 Module Manifests**: Complete dependency declarations for all domains
- **5 Artisan Commands**: domain:list, domain:install, domain:remove, domain:dependencies, domain:verify
- **Infrastructure Services**: DependencyResolver, DomainManager, ModuleManifest

### Commits
- `34fff13d` - feat(v1.3.0): Add shared domain interfaces for platform modularity
- `da37b639` - feat(v1.3.0): Add service implementations for shared interfaces
- `e581f17d` - security(v1.3.0): Add input validation and audit logging to shared services
- `ed02e999` - feat(v1.3.0): Add Module Manifest System and domain commands

---

## Executive Summary

Transform FinAegis from a monolithic domain structure to a modular architecture where domains can be installed independently. This enables:
- Faster onboarding (< 30 min vs 2+ hours)
- Customized deployments (only install needed domains)
- Cleaner testing (isolated domain tests)
- Better maintainability (loose coupling)

---

## Current State Analysis

### Domain Coupling Matrix

| Domain | Inbound Deps | Outbound Deps | Coupling Score |
|--------|--------------|---------------|----------------|
| **Account** | 209 | Low | CRITICAL (bottleneck) |
| **Asset** | 29 | Low | HIGH |
| **Wallet** | 19 | Medium | HIGH |
| **Compliance** | 17 | 121 | MEDIUM |
| **Shared** | 14 | 0 | GOOD (expected) |

### Key Issues

1. **Account Domain Bottleneck**: 209 imports across 13 domains
2. **Missing Abstractions**: No WalletOperationsInterface, AssetTransferInterface
3. **Direct Model Usage**: 70+ instances of direct Account model imports
4. **Workflow Coupling**: 50+ activity files with tight cross-domain references

---

## Implementation Phases

### Phase 1: Interface Extraction (Week 1-2)

#### 1.1 WalletOperationsInterface (Priority 1)
```php
namespace App\Domain\Shared\Contracts;

interface WalletOperationsInterface
{
    public function depositFunds(string $walletId, Money $amount): DepositResult;
    public function withdrawFunds(string $walletId, Money $amount): WithdrawalResult;
    public function getBalance(string $walletId, ?Currency $currency = null): Money;
    public function lockFunds(string $walletId, Money $amount, string $reason): LockResult;
    public function unlockFunds(string $walletId, string $lockId): void;
    public function transferBetweenWallets(string $fromId, string $toId, Money $amount): TransferResult;
}
```
**Affected Files**: 13 across Stablecoin, Basket, Exchange, Custodian

#### 1.2 AssetTransferInterface (Priority 1)
```php
namespace App\Domain\Shared\Contracts;

interface AssetTransferInterface
{
    public function transferAsset(string $assetId, string $fromOwner, string $toOwner, Amount $quantity): TransferResult;
    public function getAssetDetails(string $assetId): AssetDetails;
    public function validateAssetOperation(string $assetId, string $operation): ValidationResult;
    public function convertAsset(string $fromAssetId, string $toAssetId, Amount $quantity): ConversionResult;
}
```
**Affected Files**: 18 across AI, Exchange, Stablecoin, AgentProtocol

#### 1.3 PaymentProcessingInterface (Priority 1)
```php
namespace App\Domain\Shared\Contracts;

interface PaymentProcessingInterface
{
    public function processDeposit(DepositRequest $request): PaymentResult;
    public function processWithdrawal(WithdrawalRequest $request): PaymentResult;
    public function getPaymentStatus(string $paymentId): PaymentStatus;
    public function refundPayment(string $paymentId, ?Money $amount = null): RefundResult;
    public function validatePaymentRequest(PaymentRequest $request): ValidationResult;
}
```
**Affected Files**: Payment domain integration points

### Phase 2: High-Coupling Refactoring (Week 2-3)

#### 2.1 Target Files (Priority Order)

| File | Current Imports | Target | Action |
|------|-----------------|--------|--------|
| CollateralPositionAggregate.php | 17 | 5 | Replace with interfaces |
| AgentKycWorkflow.php | 15 | 4 | Use compliance gateway |
| AccountProjector.php | 14 | 3 | Internal only |
| LiquidityPoolProjector.php | 12 | 4 | Use exchange interfaces |
| AgentPaymentIntegrationService.php | 12 | 3 | Use payment interface |

#### 2.2 AccountQueryInterface (Read-only operations)
```php
namespace App\Domain\Shared\Contracts;

interface AccountQueryInterface
{
    public function getAccountDetails(string $accountId): ?AccountDetails;
    public function getBalance(string $accountId, ?Currency $currency = null): Money;
    public function getTransactionHistory(string $accountId, ?DateRange $range = null): TransactionCollection;
    public function accountExists(string $accountId): bool;
    public function getAccountsByOwner(string $ownerId): AccountCollection;
}
```

### Phase 3: Module Manifest System (Week 3-4)

#### 3.1 Module Manifest Schema
```json
{
    "$schema": "https://finaegis.io/schemas/module.json",
    "name": "finaegis/exchange",
    "version": "1.3.0",
    "description": "Trading and order matching engine",
    "type": "optional",
    "dependencies": {
        "required": {
            "finaegis/account": "^1.0",
            "finaegis/compliance": "^1.0"
        },
        "optional": {
            "finaegis/wallet": "^1.0"
        }
    },
    "provides": {
        "interfaces": [
            "OrderMatchingServiceInterface",
            "LiquidityPoolServiceInterface"
        ],
        "events": [
            "OrderPlaced",
            "OrderMatched",
            "TradeExecuted"
        ],
        "commands": [
            "PlaceOrderCommand",
            "CancelOrderCommand"
        ]
    },
    "paths": {
        "routes": "Routes/api.php",
        "migrations": "Database/Migrations",
        "config": "Config/exchange.php",
        "tests": "Tests"
    }
}
```

#### 3.2 Domain Categories

**Core (Always Required)**
```
app/Domain/
├── Account/          # Core accounts - REQUIRED
├── Compliance/       # KYC/AML - REQUIRED
├── Shared/           # Contracts, CQRS - REQUIRED
└── User/             # User management - REQUIRED
```

**Optional Financial**
```
├── Exchange/         # Trading engine
├── Lending/          # P2P lending
├── Treasury/         # Portfolio management
├── Stablecoin/       # Token lifecycle
├── Wallet/           # Blockchain wallets
├── Payment/          # Payment processing
└── Banking/          # Bank integrations
```

**Optional AI/Agent**
```
├── AI/               # AI framework
├── AgentProtocol/    # Agent payments (AP2)
└── Governance/       # Voting & governance
```

**Optional Infrastructure**
```
├── Monitoring/       # Metrics & alerts
├── Performance/      # Performance tracking
├── Fraud/            # Fraud detection
└── Batch/            # Batch processing
```

### Phase 4: Installation Commands (Week 4)

#### 4.1 Artisan Commands
```bash
# List available domains with dependency info
php artisan domain:list
# Output:
# ┌────────────────┬──────────┬────────────────────┬────────────┐
# │ Domain         │ Type     │ Dependencies       │ Status     │
# ├────────────────┼──────────┼────────────────────┼────────────┤
# │ account        │ core     │ -                  │ installed  │
# │ exchange       │ optional │ account,compliance │ available  │
# │ lending        │ optional │ account,compliance │ available  │
# └────────────────┴──────────┴────────────────────┴────────────┘

# Install a domain
php artisan domain:install exchange
# - Validates dependencies
# - Runs migrations
# - Publishes config
# - Registers service provider

# Check dependencies
php artisan domain:dependencies exchange
# Shows dependency tree

# Remove a domain (safe removal)
php artisan domain:remove lending
# - Checks for dependents
# - Runs down migrations
# - Removes config

# Verify domain health
php artisan domain:verify exchange
# - Checks interface implementations
# - Validates event handlers
# - Tests basic functionality
```

#### 4.2 DomainManager Service
```php
namespace App\Infrastructure\Domain;

class DomainManager
{
    public function getAvailableDomains(): Collection;
    public function getInstalledDomains(): Collection;
    public function install(string $domain): InstallResult;
    public function remove(string $domain): RemoveResult;
    public function getDependencies(string $domain): DependencyTree;
    public function verify(string $domain): VerificationResult;
}
```

---

## Success Metrics

| Metric | Current | Target v1.3.0 |
|--------|---------|---------------|
| Cross-domain imports | 900+ | <400 |
| Account coupling | 209 | <100 |
| Domains with manifest | 0 | 29 |
| Installation time | N/A | <5 min |
| Domain removal | Breaking | Non-breaking |
| Test isolation | Partial | Full |

---

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Breaking changes | Medium | High | Feature flags, phased rollout |
| Performance regression | Low | Medium | Benchmark suite |
| Test failures | Medium | Medium | Comprehensive test updates |
| Migration complexity | Medium | High | Rollback scripts |

---

## Timeline

```
Week 1: Interface Extraction (Wallet, Asset, Payment)
        └── Create interfaces
        └── Add implementations
        └── Update 10-15 files

Week 2: High-Coupling Refactoring
        └── Refactor top 6 hotspot files
        └── Add AccountQueryInterface
        └── Update tests

Week 3: Module Manifest System
        └── Create manifest schema
        └── Add manifests to all 29 domains
        └── Build manifest parser

Week 4: Installation Commands
        └── Build domain:install command
        └── Build domain:remove command
        └── Documentation & testing
```

---

## Files to Create

```
app/Domain/Shared/Contracts/
├── WalletOperationsInterface.php      # NEW
├── AssetTransferInterface.php         # NEW
├── PaymentProcessingInterface.php     # NEW
├── AccountQueryInterface.php          # NEW
└── WorkflowActivityInterface.php      # NEW

app/Infrastructure/Domain/
├── DomainManager.php                  # NEW
├── ModuleManifest.php                 # NEW
├── DependencyResolver.php             # NEW
└── Commands/
    ├── DomainListCommand.php          # NEW
    ├── DomainInstallCommand.php       # NEW
    ├── DomainRemoveCommand.php        # NEW
    └── DomainVerifyCommand.php        # NEW

app/Domain/*/module.json               # NEW (29 files)
```

---

## Next Steps (v1.4.0)

All v1.3.0 phases are complete. Future enhancements for v1.4.0:

1. **Domain Scaffolding**: `domain:create` command for generating new domains
2. **Migration Integration**: Automatic migration detection and execution
3. **Test Isolation**: Per-domain test suite configuration
4. **CI/CD Integration**: Domain-aware deployment pipelines
5. **Documentation**: Auto-generated domain API documentation

---

*Document Version: 1.1*
*Created: January 13, 2026*
*Completed: January 25, 2026*
